<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moi AIMER Toi ‚ù§Ô∏è</title>
    <style>
        /* [Le m√™me CSS que pr√©c√©demment - je le garde identique] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }
        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .particle { position: absolute; width: 4px; height: 4px; background: rgba(255,255,255,0.6); border-radius: 50%; animation: float 15s infinite; }
        @keyframes float { 0%,100%{ transform:translateY(0)translateX(0); opacity:0} 10%,90%{opacity:1} 100%{ transform:translateY(-100vh)translateX(100px); opacity:0 } }

        nav {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(102,126,234,0.95); backdrop-filter: blur(20px);
            padding: 20px 0; z-index:1000; box-shadow: 0 4px 30px rgba(0,0,0,0.1);
            animation: slideDown 0.5s ease;
        }
        @keyframes slideDown { from{transform:translateY(-100%);} to{transform:translateY(0);} }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo { font-size: 1.5em; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .heart { display: inline-block; animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0%,100%{ transform:scale(1);}10%,30%{transform:scale(1.1);}20%,40%{ transform:scale(0.9);} }
        .nav-links { display: flex; gap: 10px; list-style: none; }
        .nav-links a { color:white; text-decoration:none; padding: 12px 25px; border-radius: 25px; transition: all 0.3s; font-weight:500; }
        .nav-links a:hover,.nav-links a.active { background:rgba(255,255,255,0.2); transform:translateY(-2px); }

        .mobile-menu-btn { display: none; background: none; border: none; color: white; font-size: 1.8em; cursor: pointer;}

        .countdown-mini { position: fixed; top:80px; right:20px; background:rgba(102,126,234,0.9); backdrop-filter: blur(10px); padding: 15px 20px; border-radius: 20px; box-shadow:0 4px 20px rgba(0,0,0,0.2); z-index:999; display: none; animation: slideInRight 0.5s; }
        @keyframes slideInRight { from{transform:translateX(100%);} to{transform:translateX(0);} }
        .countdown-mini-content { display: flex; gap: 15px; font-size: 0.9em; }
        .countdown-mini-item { text-align: center; }
        .countdown-mini-number { display: block; font-size:1.5em; font-weight:bold; }
        .edit-btn { background:rgba(255,255,255,0.3); color:white; border:1px solid rgba(255,255,255,0.4); padding:12px 30px; border-radius:25px; cursor:pointer; font-size:1em; margin:10px; transition:all 0.3s; backdrop-filter: blur(5px);}
        .edit-btn:hover { background:rgba(255,255,255,0.4); transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.2);}
        .container { max-width:1200px; margin:0 auto; padding:120px 20px 40px; position:relative; z-index:2;}

        .hero { text-align:center; padding:60px 20px; animation:fadeInUp 1s ease; }
        @keyframes fadeInUp { from{opacity:0; transform:translateY(50px);} to{opacity:1; transform:translateY(0);} }
        .hero h1 { font-size:4em; margin-bottom:20px; text-shadow:2px 2px 20px rgba(0,0,0,0.3); font-weight:300; }
        .hero p { font-size:1.8em; opacity:0.95; margin-bottom:40px; }

        .countdown-section { background:rgba(255,255,255,0.15); backdrop-filter:blur(20px); border-radius:30px; padding:50px; margin:40px 0; border:1px solid rgba(255,255,255,0.3); box-shadow: 0 8px 32px rgba(0,0,0,0.2); animation:fadeIn 1s ease 0.3s both; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px);} to {opacity:1; transform:translateY(0);} }
        .countdown { display: flex; justify-content:center; gap:30px; flex-wrap:wrap; margin-top:30px; }
        .countdown-item { background:rgba(255,255,255,0.2); padding:30px; border-radius:25px; min-width:140px; text-align:center; backdrop-filter:blur(10px); transition:all 0.3s; border:1px solid rgba(255,255,255,0.3);}
        .countdown-item:hover { transform:translateY(-10px) scale(1.05); box-shadow:0 10px 30px rgba(0,0,0,0.3);}
        .countdown-number { font-size:3.5em; font-weight:bold; display:block; text-shadow:2px 2px 10px rgba(0,0,0,0.2);}
        .countdown-label { font-size:1.2em; margin-top:10px; opacity:0.95; }

        .section { background:rgba(255,255,255,0.15); backdrop-filter:blur(20px); border-radius:30px; padding:50px; margin:40px 0; border:1px solid rgba(255,255,255,0.3); box-shadow:0 8px 32px rgba(0,0,0,0.2); animation:fadeIn 1s ease; }
        h2 { font-size:2.8em; margin-bottom:30px; text-align:center; font-weight:300; text-shadow:2px 2px 10px rgba(0,0,0,0.2);}
        h3 { font-size:2em; margin-bottom:20px; font-weight:300; }

        .intro-content { font-size:1.3em; line-height:2; text-align:center; background:rgba(255,255,255,0.1); padding:40px; border-radius:20px; margin:30px 0;}
        textarea { width:100%; min-height:200px; background:rgba(255,255,255,0.95); border:none; border-radius:15px; padding:20px; font-size:1.1em; font-family:inherit; color:#333; resize:vertical;}
        input[type="text"] { width:100%; background:rgba(255,255,255,0.95); border:none; border-radius:15px; padding:15px 20px; font-size:1.1em; font-family:inherit; color:#333; margin:10px 0;}
        .hidden { display:none!important; }

        .timeline { position:relative; padding:20px 0;}
        .memory-item { display:flex; gap:30px; margin:40px 0; align-items:center; }
        .memory-item:nth-child(even) { flex-direction:row-reverse; }
        .memory-photo { flex:1; min-width:300px; max-width:500px;}
        .photo-container { position:relative; aspect-ratio:4/3; border-radius:20px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3); transition:transform 0.3s; background:rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; font-size:4em; cursor:pointer; }
        .photo-container:hover { transform:scale(1.05) rotate(2deg);}
        .photo-container img { width:100%; height:100%; object-fit:cover; display:none;}
        .photo-container span { font-size:3em; }
        .memory-text { flex:1; background:rgba(255,255,255,0.15); padding:30px; border-radius:20px; backdrop-filter:blur(10px);}
        .memory-text h3 { margin-bottom:15px; text-align:left;}
        .memory-text p { font-size:1.2em; line-height:1.8;}

        .add-memory-btn { display:block; margin:40px auto; background:rgba(255,255,255,0.3); color:white; border:2px dashed rgba(255,255,255,0.5); padding:20px 40px; border-radius:25px; cursor:pointer; font-size:1.2em; transition:all 0.3s;}
        .add-memory-btn:hover { background:rgba(255,255,255,0.4); transform:translateY(-5px);}
        .perspective-box { background:rgba(255,255,255,0.15); backdrop-filter:blur(15px); border-radius:25px; padding:40px; margin:30px 0; border:1px solid rgba(255,255,255,0.3); transition:all 0.3s;}
        .perspective-box:hover { transform:translateX(10px); box-shadow:0 10px 40px rgba(0,0,0,0.3);}
        .perspective-content { font-size:1.25em; line-height:1.9; margin:20px 0; min-height:100px;}
        .signature { text-align:right; font-style:italic; font-size:1.3em; margin-top:20px; opacity:0.9;}
        .page { display:none; }
        .page.active { display:block; }
        .text-center { text-align:center;}
        
        .delete-btn { background:rgba(255,99,71,0.5); color:white; border:1px solid rgba(255,99,71,0.6); padding:8px 20px; border-radius:20px; cursor:pointer; font-size:0.9em; margin:5px; transition:all 0.3s;}
        .delete-btn:hover { background:rgba(255,99,71,0.7); transform:translateY(-2px);}

        @media (max-width:768px) {
            .nav-links { position:fixed; top:70px; left:-100%; flex-direction:column; background:rgba(102,126,234,0.98); width:100%; padding:20px; transition:left 0.3s;}
            .nav-links.active { left:0; }
            .mobile-menu-btn { display:block;}
            .hero h1 { font-size:2.5em;}
            .hero p { font-size:1.3em;}
            .countdown { gap:15px;}
            .countdown-item { min-width:100px; padding:20px; }
            .countdown-number { font-size:2.5em;}
            .section { padding:30px 20px;}
            h2 { font-size:2em;}
            .memory-item { flex-direction:column!important;}
            .memory-photo { width:100%; min-width:auto;}
            .countdown-mini { right:10px; top:70px; padding:10px;}
            .countdown-mini-content { gap:10px; font-size:0.8em;}
        }
    </style>
</head>
<body>
<div class="particles" id="particles"></div>
<nav>
    <div class="nav-container">
        <div class="logo">
            <span class="heart">‚ù§Ô∏è</span>
            <span>Moi AIMER Toi</span>
        </div>
            <button id="authBtn" class="edit-btn" style="margin-left:10px;" onclick="handleAuth()">Login</button>
        <button class="mobile-menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <ul class="nav-links" id="navLinks">
            <li><a href="#accueil" class="nav-link active" onclick="showPage('accueil')">Accueil</a></li>
            <li><a href="#intro" class="nav-link" onclick="showPage('intro')">Notre Rencontre</a></li>
            <li><a href="#souvenirs" class="nav-link" onclick="showPage('souvenirs')">2023-2025</a></li>
            <li><a href="#perspectives" class="nav-link" onclick="showPage('perspectives')">Notre Avenir</a></li>
        </ul>
    </div>
</nav>

<div class="countdown-mini" id="countdownMini">
    <div class="countdown-mini-content">
        <div class="countdown-mini-item">
            <span class="countdown-mini-number" id="miniYears">0</span>
            <span>ans</span>
        </div>
        <div class="countdown-mini-item">
            <span class="countdown-mini-number" id="miniMonths">0</span>
            <span>mois</span>
        </div>
        <div class="countdown-mini-item">
            <span class="countdown-mini-number" id="miniDays">0</span>
            <span>jours</span>
        </div>
    </div>
</div>

<div class="container">
    <!-- PAGE ACCUEIL -->
    <div id="accueil" class="page active">
        <div class="hero">
            <h1>2 -> ‚àû With YOU <span class="heart">üíô</span></h1>
            <p>Depuis le <span id="startDateDisplay">10 novembre 2023</span></p>
        </div>
        <div class="text-center">
            <button class="edit-btn" onclick="editStartDate()">üìÖ Modifier la date</button>
        </div>
        <div class="countdown-section">
            <h2>Ensemble depuis...</h2>
            <div class="countdown">
                <div class="countdown-item">
                    <span class="countdown-number" id="years">0</span>
                    <span class="countdown-label">Ann√©es</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-number" id="months">0</span>
                    <span class="countdown-label">Mois</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-number" id="days">0</span>
                    <span class="countdown-label">Jours</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-number" id="hours">0</span>
                    <span class="countdown-label">Heures</span>
                </div>
            </div>
        </div>
        <div class="section">
            <h2>Coucou Ma VIEEEEE üíú</h2>
            <div class="intro-content" id="homeMessageDisplay">
                Deux ans ensemble, et chaque jour avec toi est un cadeau pr√©cieux. 
                Tu illumines ma vie de ton sourire et de ta pr√©sence. 
                J'ai passe quelques heures a coder ce site pour nous, pour que l'on puisse toujours garder une trace de notre belle histoire.
                C'est notre petit coin √† nous, un endroit o√π je peux te rappeler √† quel point tu es sp√©ciale pour moi.
                C'est aussi un espace pour r√™ver √† notre avenir ensemble, pour imaginer tous les moments merveilleux qui nous attendent.
                C'est egalement un moyen pour moi de te montrer √† quel point je tiens √† toi, √† quel point tu comptes dans ma vie.
                Pour toi, ma tres chere Eunice que j'aime tant ‚ù§Ô∏è, 
                Voici √† tous nos souvenirs pass√©s et √† tous ceux qui restent √† cr√©er. 
                Je t'aime ‚ù§Ô∏è
                Du coup, voici un petit guide pour utiliser ce site :
                <ul>
                    <li>Utilise le menu en haut pour naviguer entre les diff√©rentes sections.</li>
                    <li>Dans "Notre Rencontre", tu peux personnaliser notre histoire en cliquant sur le bouton "Personnaliser notre histoire".</li>
                    <li>Dans "2023-2025", tu peux ajouter des souvenirs en cliquant sur "Ajouter un souvenir". Tu peux aussi modifier ou supprimer chaque souvenir individuellement.</li>
                    <li>Dans "Notre Avenir", tu peux √©crire tes propres r√™ves et perspectives pour notre futur ensemble.</li>
                    <li>N'h√©site pas √† modifier les textes autant de fois que tu veux, c'est notre espace √† nous !</li>
            </div>
            <div class="text-center">
                <button class="edit-btn" onclick="editHomeMessage()">‚úèÔ∏è Modifier</button>
            </div>
            <div id="homeMessageEdit" class="hidden">
                <textarea id="homeMessageText"></textarea>
                <div class="text-center">
                    <button class="edit-btn" onclick="saveHomeMessage()">üíæ Enregistrer</button>
                    <button class="edit-btn" onclick="cancelHomeEdit()">‚ùå Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE INTRO -->
    <div id="intro" class="page">
        <div class="section">
            <h2>Notre Rencontre üí´</h2>
            <div class="intro-content" id="introDisplay">
                Tu sais, quand je repense √† notre histoire, j‚Äôme dis que le destin a vraiment bien fait les choses. On s‚Äôest connus quand j‚Äô√©tais en premi√®re, t‚Äô√©tais juste en face de moi en classe, sur le banc de devant. On se parlait √† peine, juste quelques mots de temps en temps, sans vraiment se conna√Ætre. Franchement, jamais j‚Äôaurais imagin√© qu‚Äôun jour, six ans plus tard, on f√™terait nos deux ans de relation. √Ä ce moment-l√†, on n‚Äô√©tait m√™me pas amis, juste des camarades, rien de plus.
Et puis un jour, en suivant Jordy, j‚Äôsuis all√© chez toi. Ce jour-l√†, sans le savoir, tout a commenc√© √† changer. On a commenc√© √† se parler un peu plus, √† rigoler, √† se comprendre. Un an apr√®s mon bac, on est devenus vraiment proches, de vrais amis. Et c‚Äôest l√† que j‚Äôai commenc√© √† ressentir quelque chose pour toi, un truc diff√©rent, sinc√®re. Mais toi, √† ce moment-l√†, tu me voyais juste comme ton ami, et j‚Äôrespectais √ßa. On a continu√© nos vies chacun de notre c√¥t√©, sans se douter que le destin pr√©parait la suite.
Puis est arriv√© ce mois d‚Äôoctobre 2023‚Ä¶ le plus dur de ma vie. J‚Äôsuis tomb√© gravement malade, j‚Äôai d√ª me faire op√©rer du c≈ìur. C‚Äô√©tait une p√©riode hyper compliqu√©e, mais t‚Äô√©tais l√†. √Ä chaque instant. T‚Äôas jamais l√¢ch√©, tu m‚Äôas soutenu, t‚Äôas pris soin de moi. Et c‚Äôest l√† que t‚Äôas r√©alis√© que tu voulais pas me perdre. Le 10 novembre 2023, nos chemins se sont enfin rejoints pour de vrai.
Depuis ce jour-l√†, c‚Äôest juste le bonheur. Deux ann√©es pleines d‚Äôamour, de rires, de complicit√©. Les deux plus belles ann√©es de ma vie. Tu m‚Äôas prouv√© que certaines histoires prennent du temps √† commencer, mais quand elles d√©marrent enfin, elles deviennent tout simplement inoubliables. ‚ù§Ô∏è
            </div>
            <div class="text-center">
                <button class="edit-btn" onclick="editIntro()">‚úèÔ∏è Personnaliser notre histoire</button>
            </div>
            <div id="introEdit" class="hidden">
                <textarea id="introText"></textarea>
                <div class="text-center">
                    <button class="edit-btn" onclick="saveIntro()">üíæ Enregistrer</button>
                    <button class="edit-btn" onclick="cancelIntroEdit()">‚ùå Annuler</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PAGE SOUVENIRS -->
    <div id="souvenirs" class="page">
        <div class="section">
            <h2>Nos Plus Beaux Moments üì∏</h2>
            <p style="text-align:center; font-size:1.2em; opacity:0.9; margin-bottom:40px;">
                Chaque photo raconte une partie de notre histoire...
            </p>
            <div class="timeline" id="memoriesContainer">
                <!-- Les souvenirs seront ajout√©s dynamiquement ici -->
            </div>
            <button class="add-memory-btn" onclick="addNewMemory()">
                ‚ûï Ajouter un souvenir
            </button>
        </div>
    </div>
    
    <!-- PAGE PERSPECTIVES -->
    <div id="perspectives" class="page">
        <div class="section">
            <h2>Notre Avenir Ensemble üåü</h2>
            <div class="perspective-box">
                <h3>Mes R√™ves Pour Nous üíô</h3>
                <div class="perspective-content" id="perspective1Display">
                    Aujourd‚Äôhui, quand je pense √† nous, j‚Äôimagine tout ce qu‚Äôon peut construire ensemble. Je r√™ve qu‚Äôon continue √† se soutenir dans tous nos projets, √† se faire rire m√™me dans les moments difficiles, √† vivre des aventures qu‚Äôon n‚Äôosait m√™me pas imaginer avant. Je veux qu‚Äôon grandisse c√¥te √† c√¥te, qu‚Äôon se pousse l‚Äôun l‚Äôautre √† devenir la meilleure version de nous-m√™mes, sans jamais perdre cette complicit√© qui nous rend uniques. Je nous imagine dans quelques ann√©es, cr√©ant notre petit monde, plein de souvenirs, de voyages, de rires et d‚Äôamour, unis face √† tout ce que la vie nous r√©serve. Et peu importe les obstacles, je sais qu‚Äôavec toi √† mes c√¥t√©s, tout devient possible. ‚ù§Ô∏è
                </div>
                <div class="signature">- Avec tout mon amour üíô DADDY</div>
                <div class="text-center">
                    <button class="edit-btn" onclick="editPerspective(1)">‚úèÔ∏è Personnaliser</button>
                </div>
                <div id="perspective1Edit" class="hidden">
                    <textarea id="perspective1Text"></textarea>
                    <div class="text-center">
                        <button class="edit-btn" onclick="savePerspective(1)">üíæ Enregistrer</button>
                        <button class="edit-btn" onclick="cancelPerspectiveEdit(1)">‚ùå Annuler</button>
                    </div>
                </div>
            </div>
            <div class="perspective-box">
                <h3>Mes R√™ves Pour Nous üíú</h3>
                <div class="perspective-content" id="perspective2Display">
                    C'est a toi BIG MAMAAAA de me dire ce que tu esp√®re pour nous! Je T'AIME ‚ù§Ô∏è
                <div class="signature">- Avec tout mon amour üíú</div>
                <div class="text-center">
                    <button class="edit-btn" onclick="editPerspective(2)">‚úèÔ∏è Ajouter mes r√™ves</button>
                </div>
                <div id="perspective2Edit" class="hidden">
                    <textarea id="perspective2Text"></textarea>
                    <div class="text-center">
                        <button class="edit-btn" onclick="savePerspective(2)">üíæ Enregistrer</button>
                        <button class="edit-btn" onclick="cancelPerspectiveEdit(2)">‚ùå Annuler</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // API config
    const API_BASE = 'http://localhost:3001';
    const API_KEY = 'dev-key'; // fallback API key for local dev

    // Particles
    const particlesContainer = document.getElementById('particles');
    for (let i = 0; i < 60; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 15 + 's';
        particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
        particlesContainer.appendChild(particle);
    }

    // Navigation
    let currentPage = 'accueil';
    function showPage(pageName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageName).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + pageName) link.classList.add('active');
        });
        document.getElementById('countdownMini').style.display = (pageName === 'accueil') ? 'none' : 'block';
        document.getElementById('navLinks').classList.remove('active');
        window.scrollTo(0, 0);
        currentPage = pageName;
    }
    function toggleMenu() { document.getElementById('navLinks').classList.toggle('active'); }
    document.addEventListener('click', function(event) {
        const nav = document.getElementById('navLinks');
        const btn = document.querySelector('.mobile-menu-btn');
        if (!nav.contains(event.target) && !btn.contains(event.target)) nav.classList.remove('active');
    });

    // State
    let memories = [];
    let coupleData = { start_date: '2023-11-10' };

    // Countdown
    function updateCountdown() {
        const dateStr = coupleData.start_date || '2023-11-10';
        const dateAffich = new Date(dateStr);
        document.getElementById('startDateDisplay').textContent = dateAffich.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
        const startDate = new Date(dateStr + 'T00:00:00');
        const now = new Date(), diff = now - startDate;
        const years = Math.floor(diff / (1000*60*60*24*365.25));
        const months = Math.floor((diff % (1000*60*60*24*365.25)) / (1000*60*60*24*30.44));
        const days = Math.floor((diff % (1000*60*60*24*30.44)) / (1000*60*60*24));
        const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
        document.getElementById('years').textContent = years;
        document.getElementById('months').textContent = months;
        document.getElementById('days').textContent = days;
        document.getElementById('hours').textContent = hours;
        document.getElementById('miniYears').textContent = years;
        document.getElementById('miniMonths').textContent = months;
        document.getElementById('miniDays').textContent = days;
    }

    // API helpers
    function getAuthHeaders() {
        const token = localStorage.getItem('auth_token');
        if (token) return { 'Authorization': 'Bearer ' + token };
        if (API_KEY) return { 'X-API-KEY': API_KEY };
        return {};
    }

    async function apiFetch(path, opts = {}) {
        opts.headers = Object.assign({}, getAuthHeaders(), opts.headers || {});
        const res = await fetch(API_BASE + path, opts);
        if (!res.ok) throw new Error(`API ${path} error: ${res.status}`);
        return res.json();
    }

    // Auth helpers
    function updateAuthButton() {
        const btn = document.getElementById('authBtn');
        const token = localStorage.getItem('auth_token');
        btn.textContent = token ? 'Logout' : 'Login';
    }

    async function handleAuth() {
        const token = localStorage.getItem('auth_token');
        if (token) {
            // logout
            localStorage.removeItem('auth_token');
            updateAuthButton();
            alert('Logged out');
            return;
        }
        // login flow
        const username = prompt('Admin username:', 'admin');
        if (!username) return;
        const password = prompt('Admin password:');
        if (!password) return;
        try {
            const res = await fetch(`${API_BASE}/api/auth/login`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password })
            });
            if (!res.ok) throw new Error('Login failed');
            const data = await res.json();
            localStorage.setItem('auth_token', data.token);
            updateAuthButton();
            alert('Logged in');
        } catch (err) {
            console.error('Login error', err);
            alert('Login failed');
        }
    }

    // Load initial data from backend
    async function loadInitialData() {
        try {
            const couple = await apiFetch('/api/couple-data');
            coupleData = couple || coupleData;
            document.getElementById('homeMessageDisplay').textContent = couple.home_message || document.getElementById('homeMessageDisplay').textContent;
            document.getElementById('introDisplay').textContent = couple.intro_text || document.getElementById('introDisplay').textContent;
            updateCountdown();

            const mems = await apiFetch('/api/memories');
            memories = mems || [];
            document.getElementById('memoriesContainer').innerHTML = '';
            memories.forEach(createMemoryElement);

            const perspectives = await apiFetch('/api/perspectives');
            perspectives.forEach(p => {
                const el = document.getElementById('perspective' + p.perspective_number + 'Display');
                if (el) el.textContent = p.content;
            });
        } catch (err) {
            console.error('Error loading data:', err);
        }
    }

    // Memories UI
    function createMemoryElement(memory) {
        const container = document.getElementById('memoriesContainer');
        const memoryDiv = document.createElement('div');
        memoryDiv.className = 'memory-item';
        memoryDiv.setAttribute('data-id', memory.id);
        
        const photoHtml = memory.photo_url ? `<img id="photo-${memory.id}" src="${memory.photo_url}" alt="Photo souvenir" style="display:block">` : `<span id="placeholder-${memory.id}">üì∑</span>`;

        memoryDiv.innerHTML = `
            <div class="memory-photo">
                <div class="photo-container" onclick="selectPhoto(${memory.id})">
                    ${photoHtml}
                    <input type="file" id="upload-${memory.id}" accept="image/*" style="display:none;">
                </div>
            </div>
            <div class="memory-text">
                <h3 id="title-${memory.id}">${escapeHtml(memory.title)}</h3>
                <p id="text-${memory.id}">${escapeHtml(memory.description)}</p>
                <div class="text-center">
                    <button class="edit-btn" onclick="editMemoryItem(${memory.id})">‚úèÔ∏è Modifier</button>
                    <button class="delete-btn" onclick="deleteMemory(${memory.id})">üóëÔ∏è Supprimer</button>
                </div>
            </div>
        `;

        container.appendChild(memoryDiv);

        // wire upload input
        const input = document.getElementById(`upload-${memory.id}`);
        input.addEventListener('change', () => uploadMemoryPhoto(memory.id));
    }

    function selectPhoto(id) { document.getElementById(`upload-${id}`).click(); }

    async function uploadMemoryPhoto(id) {
        const input = document.getElementById(`upload-${id}`);
        const file = input.files[0];
        if (!file) return;
        const form = new FormData();
        form.append('photo', file);
        // include title/description to keep them
        const mem = memories.find(m => m.id === id);
        form.append('title', mem ? mem.title : '');
        form.append('description', mem ? mem.description : '');

        try {
            const res = await fetch(`${API_BASE}/api/memories/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: form
            });
            if (!res.ok) throw new Error('Upload failed');
            // refresh memory
            const updated = await apiFetch(`/api/memories/${id}`);
            const img = document.getElementById(`photo-${id}`);
            const placeholder = document.getElementById(`placeholder-${id}`);
            if (updated.photo_url) {
                if (img) img.src = updated.photo_url;
                else {
                    // replace placeholder with img
                    const container = document.querySelector(`[data-id="${id}"] .photo-container`);
                    container.innerHTML = `<img id="photo-${id}" src="${updated.photo_url}" style="display:block"> <input type="file" id="upload-${id}" accept="image/*" style="display:none;">`;
                    document.getElementById(`upload-${id}`).addEventListener('change', () => uploadMemoryPhoto(id));
                }
                if (placeholder) placeholder.style.display = 'none';
            }
        } catch (err) {
            console.error('Error uploading photo:', err);
            alert('Erreur lors de l envoi de la photo');
        }
    }

    async function addNewMemory() {
        const title = prompt('Titre du souvenir :', 'Un Moment Sp√©cial');
        if (!title) return;
        const description = prompt('Description du souvenir :', 'D√©crivez ce moment pr√©cieux...');
        if (!description) return;
        try {
            const created = await apiFetch('/api/memories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description })
            });
            memories.unshift(created);
            createMemoryElement(created);
        } catch (err) {
            console.error('Error creating memory:', err);
            alert('Impossible de cr√©er le souvenir');
        }
    }

    async function editMemoryItem(id) {
        const mem = memories.find(m => m.id === id);
        if (!mem) return;
        const newTitle = prompt('Nouveau titre :', mem.title);
        if (!newTitle) return;
        const newDesc = prompt('Nouvelle description :', mem.description);
        if (!newDesc) return;
        try {
            await apiFetch(`/api/memories/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newTitle, description: newDesc })
            });
            mem.title = newTitle; mem.description = newDesc;
            document.getElementById(`title-${id}`).textContent = newTitle;
            document.getElementById(`text-${id}`).textContent = newDesc;
        } catch (err) { console.error(err); alert('Erreur lors de la mise √† jour'); }
    }

    async function deleteMemory(id) {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce souvenir ?')) return;
        try {
            await fetch(`${API_BASE}/api/memories/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
            memories = memories.filter(m => m.id !== id);
            const el = document.querySelector(`[data-id="${id}"]`); if (el) el.remove();
        } catch (err) { console.error(err); alert('Erreur lors de la suppression'); }
    }

    // Couple data handlers
    function editStartDate() {
        const newDate = prompt('Entrez la date de d√©but (format: AAAA-MM-JJ):', coupleData.start_date);
        if (!newDate) return;
        fetch(`${API_BASE}/api/couple-data/start-date`, {
            method: 'PUT', headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()),
            body: JSON.stringify({ start_date: newDate })
        }).then(r => { if (r.ok) { coupleData.start_date = newDate; updateCountdown(); } else throw r; }).catch(e => { console.error(e); alert('Erreur'); });
    }

    async function saveHomeMessage() {
        const textarea = document.getElementById('homeMessageText');
        try {
            await fetch(`${API_BASE}/api/couple-data/home-message`, { method: 'PUT', headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()), body: JSON.stringify({ home_message: textarea.value }) });
            document.getElementById('homeMessageDisplay').textContent = textarea.value;
            document.getElementById('homeMessageEdit').classList.add('hidden');
        } catch (err) { console.error(err); alert('Erreur'); }
    }

    async function saveIntro() {
        const textarea = document.getElementById('introText');
        try {
            await fetch(`${API_BASE}/api/couple-data/intro`, { method: 'PUT', headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()), body: JSON.stringify({ intro_text: textarea.value }) });
            document.getElementById('introDisplay').textContent = textarea.value;
            document.getElementById('introEdit').classList.add('hidden');
        } catch (err) { console.error(err); alert('Erreur'); }
    }

    async function savePerspective(num) {
        const textarea = document.getElementById('perspective'+num+'Text');
        try {
            await fetch(`${API_BASE}/api/perspectives`, { method: 'POST', headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()), body: JSON.stringify({ perspective_number: num, content: textarea.value }) });
            document.getElementById('perspective'+num+'Display').textContent = textarea.value;
            document.getElementById('perspective'+num+'Edit').classList.add('hidden');
        } catch (err) { console.error(err); alert('Erreur'); }
    }

    // Helpers
    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Wire up button-based edit/cancel to reuse existing code areas
    function editHomeMessage(){
        const display = document.getElementById('homeMessageDisplay');
        const edit = document.getElementById('homeMessageEdit');
        const textarea = document.getElementById('homeMessageText');
        textarea.value = display.textContent.trim();
        display.style.display = 'none'; edit.classList.remove('hidden');
    }
    function cancelHomeEdit(){ document.getElementById('homeMessageEdit').classList.add('hidden'); document.getElementById('homeMessageDisplay').style.display = 'block'; }
    function editIntro(){ const display = document.getElementById('introDisplay'); const edit = document.getElementById('introEdit'); const textarea = document.getElementById('introText'); textarea.value = display.textContent.trim(); display.style.display='none'; edit.classList.remove('hidden'); }
    function cancelIntroEdit(){ document.getElementById('introEdit').classList.add('hidden'); document.getElementById('introDisplay').style.display='block'; }
    function editPerspective(num){ const display=document.getElementById('perspective'+num+'Display'); const edit=document.getElementById('perspective'+num+'Edit'); const textarea=document.getElementById('perspective'+num+'Text'); textarea.value=display.textContent.trim(); display.style.display='none'; edit.classList.remove('hidden'); }
    function cancelPerspectiveEdit(num){ document.getElementById('perspective'+num+'Edit').classList.add('hidden'); document.getElementById('perspective'+num+'Display').style.display='block'; }

    // Startup
    window.addEventListener('DOMContentLoaded', () => { loadInitialData(); setInterval(updateCountdown, 3600000); document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e)=>e.preventDefault())); updateAuthButton(); });
</script>
</body>
</html>
